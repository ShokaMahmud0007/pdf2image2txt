<full app.py content here, trimmed for display>